{% extends "base.html" %}

{% block title %}GRAVIS: Galactic Rotation from Field Dynamics{% endblock %}

{% block head %}
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
{% endblock %}

{% block before_nav %}
    <!-- Splash overlay: renders instantly before deferred scripts load -->
    <div id="splash-overlay" style="
        position: fixed; inset: 0; z-index: 9999;
        background: #000000;
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        transition: opacity 0.5s ease-out;
    ">
        <style>
            @keyframes splashBounce {
                0%   { left: 0; }
                50%  { left: calc(100% - 60px); }
                100% { left: 0; }
            }
        </style>
        <div style="display: flex; flex-direction: column; align-items: stretch;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    user-select: none;">
            <div style="
                font-size: 4.5em; font-weight: 700;
                color: #4da6ff; letter-spacing: 12px;
                text-align: center;
            ">GRAVIS</div>
            <div style="
                font-size: 1.05em; font-weight: 400;
                color: #707070; letter-spacing: 0.5px;
                text-align: center; margin-top: 10px;
            ">Galactic Rotation from Field Dynamics</div>
            <div style="
                width: 100%; height: 3px;
                background: #1a1a1a;
                border-radius: 2px;
                margin-top: 28px;
                position: relative;
                overflow: hidden;
            ">
                <div style="
                    position: absolute; top: 0;
                    width: 60px; height: 100%;
                    background: #4da6ff;
                    border-radius: 2px;
                    animation: splashBounce 1.4s ease-in-out infinite;
                "></div>
            </div>
            <div style="
                font-size: 0.72em; font-weight: 400;
                color: #333333; letter-spacing: 0.5px;
                text-align: center; margin-top: 24px;
            ">Open Source &middot; MIT License &middot; 2026</div>
        </div>
    </div>
    <script>
        if (sessionStorage.getItem('gravis_loaded')) {
            document.getElementById('splash-overlay').remove();
        } else {
            sessionStorage.setItem('gravis_loaded', '1');
        }
    </script>
{% endblock %}

{% block content %}
    <div class="screen-container">
        <div class="screen active" id="screen-analysis" style="display: flex;">
            <div class="left-panel" id="left-panel">
                <!-- Mode Toggle -->
                <div class="mode-toggle">
                    <div class="mode-toggle-label">Analysis Mode</div>
                    <div class="mode-buttons">
                        <button class="mode-button active" id="mode-prediction" onclick="setMode('prediction')">
                            Prediction (M&#x2192;v)
                        </button>
                        <button class="mode-button" id="mode-inference" onclick="setMode('inference')">
                            Inference (v&#x2192;M)
                        </button>
                    </div>
                </div>

                <!-- Examples Section -->
                <div class="examples-section">
                    <div class="examples-header" style="cursor: default;">
                        <span class="examples-header-text">Load Example</span>
                    </div>
                    <div class="examples-content expanded" id="examples-content">
                        <div class="examples-dropdown-wrapper">
                            <select class="examples-dropdown" id="examples-dropdown" onchange="loadExample()">
                            </select>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span id="distance-label">Distance Scale (r)</span>
                        <span class="control-value" id="distance-value">10 kpc</span>
                    </div>
                    <input type="range" id="distance-slider" min="0.1" max="100" step="0.1" value="10">
                    <input type="hidden" id="anchor-radius" value="10">
                </div>

                <div class="control-group" id="mass-slider-group" style="display: none;">
                    <div class="control-label">
                        <span id="mass-label">Mass (M)</span>
                        <span class="control-value" id="mass-value">10&#x00B9;&#x00B9; M&#x2609;</span>
                    </div>
                    <input type="range" id="mass-slider" min="8" max="13" step="0.1" value="11">
                </div>

                <!-- Mass Distribution Panel -->
                <div class="mass-model-section" id="mass-model-section">
                    <div class="mass-model-header" style="cursor: default;">
                        <span class="mass-model-header-text">Mass Distribution</span>
                    </div>
                    <div class="mass-model-content expanded" id="mass-model-content">
                        <div class="mass-model-body">
                            <div class="mass-component bulge">
                                <div class="mass-component-title">Stellar Bulge (Hernquist)</div>
                                <div class="control-label">
                                    <span>Mass</span>
                                    <span class="control-value" id="bulge-mass-value">1.5e10 M_sun</span>
                                </div>
                                <input type="range" id="bulge-mass-slider" min="7" max="11.5" step="0.01" value="10.176">
                                <div class="control-label">
                                    <span>Scale radius (a)</span>
                                    <span class="control-value" id="bulge-scale-value">0.6 kpc</span>
                                </div>
                                <input type="range" id="bulge-scale-slider" min="0.1" max="3.0" step="0.1" value="0.6">
                            </div>
                            <div class="mass-component disk">
                                <div class="mass-component-title">Stellar Disk (Exponential)</div>
                                <div class="control-label">
                                    <span>Mass</span>
                                    <span class="control-value" id="disk-mass-value">5.0e10 M_sun</span>
                                </div>
                                <input type="range" id="disk-mass-slider" min="7" max="12" step="0.01" value="10.699">
                                <div class="control-label">
                                    <span>Scale length (R_d)</span>
                                    <span class="control-value" id="disk-scale-value">2.5 kpc</span>
                                </div>
                                <input type="range" id="disk-scale-slider" min="0.5" max="10" step="0.1" value="2.5">
                            </div>
                            <div class="mass-component gas">
                                <div class="mass-component-title">Gas Disk (HI + H2 + He)</div>
                                <div class="control-label">
                                    <span>Mass</span>
                                    <span class="control-value" id="gas-mass-value">1.0e10 M_sun</span>
                                </div>
                                <input type="range" id="gas-mass-slider" min="7" max="11.5" step="0.01" value="10">
                                <div class="control-label">
                                    <span>Scale length (R_d)</span>
                                    <span class="control-value" id="gas-scale-value">5.0 kpc</span>
                                </div>
                                <input type="range" id="gas-scale-slider" min="1" max="25" step="0.5" value="5">
                            </div>
                            <div class="mass-model-total-row">
                                <span>Total Baryonic Mass</span>
                                <span class="control-value" id="mass-model-total-value">7.5e10 M_sun</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-group" id="velocity-control" style="display: none;">
                    <div class="control-label">
                        <span>Observed Velocity (v)</span>
                        <span class="control-value" id="velocity-value">200 km/s</span>
                    </div>
                    <input type="range" id="velocity-slider" min="50" max="400" step="1" value="200">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span>Acceleration Regime</span>
                        <span class="control-value" id="accel-value">a/a&#x2080; = 1.0</span>
                    </div>
                    <input type="range" id="accel-slider" min="0.01" max="100" step="0.01" value="1">
                </div>

                <div class="inference-result" id="inference-result">
                    <div style="font-size: 0.8em; color: #808080; margin-bottom: 6px;">
                        Anchor: <strong style="color: #b0b0b0;"><span id="anchor-display">v km/s at r kpc</span></strong>
                    </div>
                    <strong>Inferred Total Mass (GFD):</strong> <span id="inferred-mass-value"></span>
                    <br><br>
                    <strong>BTFR Mass (v&#x2074;/Ga&#x2080;):</strong> <span id="btfr-mass-value"></span>
                    <br>
                    <span style="font-size: 0.8em; color: #808080;">
                        Baryonic Tully-Fisher: model-independent estimate from flat velocity
                    </span>
                    <div id="multi-inference-result" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #404040;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: #4da6ff;">Multi-Point Consistency</strong>
                            <select id="band-method-select" title="Confidence band method" style="background: #1a1a1a; color: #b0b0b0; border: 1px solid #404040; border-radius: 4px; padding: 3px 6px; font-size: 0.8em; cursor: pointer;">
                                <option value="weighted_rms" title="Spread of per-point inferences vs GFD prediction, weighted by enclosed fraction">Weighted RMS</option>
                                <option value="weighted_scatter" title="Weighted standard deviation of per-point inferences around their mean">1&#x03C3; Scatter</option>
                                <option value="obs_error" title="Propagated velocity measurement uncertainties through the field equation">Obs. Error</option>
                                <option value="min_max" title="Full range of per-point inferred masses (most conservative)">Min-Max</option>
                                <option value="iqr" title="Interquartile range, resistant to outlier inner points">IQR (Robust)</option>
                            </select>
                        </div>
                        <div id="multi-inference-body" style="font-size: 0.85em; color: #b0b0b0; line-height: 1.6;"></div>
                    </div>
                </div>

                <div id="observed-legend" style="display: none;"></div>

                <div id="cdm-halo-info" style="display: none; margin-top: 12px; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; font-size: 0.85em; line-height: 1.6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #ffffff;">&Lambda;CDM + NFW Halo</strong>
                        <span style="font-size: 0.8em; color: #808080; font-style: italic;" id="cdm-fit-method"></span>
                    </div>
                    <div id="cdm-halo-details" style="color: #b0b0b0;"></div>
                    <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #333;">
                        <table style="width: 100%; font-size: 0.9em;">
                            <tr>
                                <td style="color: #808080;">Theory</td>
                                <td style="text-align: right; color: #808080;">Free Parameters</td>
                            </tr>
                            <tr>
                                <td style="color: #4da6ff;">Gravity Field Dynamics</td>
                                <td style="text-align: right; color: #4caf50; font-weight: bold;">0</td>
                            </tr>
                            <tr>
                                <td style="color: #ffffff;">&Lambda;CDM + NFW</td>
                                <td style="text-align: right; color: #ef5350; font-weight: bold;" id="cdm-param-count">2</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

            <div class="resize-handle" id="resize-handle"></div>

            <div class="right-panel">
                <div class="chart-container">
                    <div id="chart-face" class="card-face">
                        <canvas id="gravityChart"></canvas>
                        <button id="reset-zoom-btn" class="reset-zoom-button" style="display: none;">
                            &#x1F504; Reset Zoom
                        </button>
                        <button id="data-card-btn" class="data-card-button" style="display: none;"
                                onclick="openDataCard()">Data Sources</button>
                    </div>
                    <div id="data-face" class="card-face" style="display: none;">
                        <button class="data-card-button" onclick="closeDataCard()">Back to Chart</button>
                        <div class="data-card-body">
                            <h2 id="dc-title" class="dc-title"></h2>
                            <div id="dc-summary" class="dc-section"></div>

                            <h3>Mass Model</h3>
                            <table class="dc-table">
                                <thead>
                                    <tr><th>Component</th><th>Mass (M_sun)</th><th>Scale (kpc)</th><th>Profile</th></tr>
                                </thead>
                                <tbody id="dc-mass-tbody"></tbody>
                            </table>
                            <div id="dc-total-mass" class="dc-total"></div>

                            <h3>Observational Data</h3>
                            <table class="dc-table">
                                <thead>
                                    <tr><th>r (kpc)</th><th>v (km/s)</th><th>1-sigma (km/s)</th></tr>
                                </thead>
                                <tbody id="dc-obs-tbody"></tbody>
                            </table>

                            <h3>References</h3>
                            <ul id="dc-references" class="dc-references"></ul>

                            <div id="dc-methodology" class="dc-methodology"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script defer src="{{ url_for('static', filename='js/gravis.js') }}"></script>
{% endblock %}
